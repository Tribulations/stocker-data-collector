# Stocker Data Collector
A backend service built in Java for collecting and storing stock market data from third-party APIs. This component focuses on data fetching, parsing, and storage, keeping the system modular, reliable, and easy to maintain.

The stored data can be accessed via a separate REST API component: [Stocker REST API](https://github.com/Tribulations/stocker-rest-api).

# Table of Contents
- [Requirements](#Requirements)
- [System Description](#System-Description)
- [UML diagrams](#UML-diagrams)

## Requirements

- Docker is required to run tests as these use testcontainers

## System Description
*The description below was generated by [SDG](https://github.com/Tribulations/system-description-generator)*

# Stocker Data Collector - System Overview

## 1. System Purpose
The **stocker-data-collector** is a Java application that fetches historical stock market data (candlestick/OHLCV data) from external financial APIs, parses the responses, and persists the data into a relational database for analysis and storage.

## 2. Key Components & Responsibilities

### Data Fetching Layer
- **BaseDataFetcher**: Abstract base class handling HTTP requests to external APIs using Java's HttpClient
- **YahooFinanceFetcher**: Fetches stock data from Yahoo Finance API
- **FinanceBirdFetcher**: Fetches stock data from FinanceBird API
- Both fetchers use environment variables (via Dotenv) for API configuration

### Data Parsing Layer
- **BaseParser**: Abstract parser implementing AutoCloseable, uses Gson's streaming API (JsonReader) to parse JSON responses
- **YahooFinanceParser**: Parses Yahoo Finance JSON format into TradingPeriod objects
- **FinanceBirdParser**: Parses FinanceBird JSON format into TradingPeriod objects
- Both parsers extract OHLCV data (Open, High, Low, Close, Volume) along with timestamps and symbols

### Data Service Layer
- **StockDataService**: Orchestrates the data collection process, coordinating between fetchers, parsers, and database operations
- Supports configurable delays between API requests
- Handles Range and Interval parameters for data queries

### Database Layer
- **DatabaseManager**: Manages database connections using JDBC DriverManager and initializes the database schema
- **MigrationManager**: Handles database schema migrations using Flyway
- **CandlestickDao**: Data Access Object implementing the DAO interface for CRUD operations on candlestick data
- **DatabaseConfig**: Configuration holder for database connection parameters
- **DbConstants**: Centralized database constants (table names, column names, SQL queries)

### Domain Models
- **Candlestick**: Represents individual OHLCV data points
- **TradingPeriod**: Represents a collection of candlesticks for a specific time period
- **Stock**: Represents stock entities with metadata
- **Range**: Defines time range for data queries
- **Interval**: Defines data granularity (e.g., 1m, 5m, 1h, 1d)

### Validation & Utilities
- **DataFetcherInputValidator**: Validates URLs and input parameters for data fetchers using regex patterns
- **DatabaseInputValidator**: Validates data before database operations
- **StockReader**: Utility for reading stock symbols (referenced in Main)
- **DataFetchException**: Custom exception for data fetching errors

### Entry Point
- **Main**: Application entry point that initializes the database, configures fetchers/parsers, and triggers data collection

## 3. Core Technologies & Dependencies

- **Java**: Primary programming language (uses java.net.http, java.sql, java.util.stream)
- **JDBC**: Database connectivity
- **Flyway**: Database migration management
- **Gson**: JSON parsing with streaming API support
- **SLF4J**: Logging facade (with Logback/Log4j implementation)
- **Dotenv**: Environment variable management for configuration
- **SQL Database**: Relational database (specific vendor determined by JDBC driver configuration)

## 4. Architecture

The system follows a **layered architecture** with clear separation of concerns:

```
Presentation Layer:     Main (Entry Point)
                          ↓
Service Layer:         StockDataService
                          ↓
Data Access Layer:     Fetchers → Parsers → DAOs
                          ↓
Persistence Layer:     DatabaseManager → SQL Database
```

**Design Patterns Used:**
- **DAO Pattern**: Abstracts database operations (DAO interface, CandlestickDao)
- **Template Method**: BaseParser and BaseDataFetcher provide common functionality
- **Strategy Pattern**: Interchangeable fetchers and parsers for different data sources
- **Dependency Injection**: Components receive dependencies (parsers, fetchers, database config)

## 5. Data Flow

1. **Initialization Phase**:
   - Main creates DatabaseManager and initializes database connection
   - MigrationManager runs Flyway migrations to ensure schema is current
   - DatabaseConfig provides connection parameters

2. **Data Collection Phase**:
   - StockDataService receives stock symbols, range, and interval parameters
   - DataFetcherInputValidator validates input parameters
   - BaseDataFetcher (YahooFinanceFetcher or FinanceBirdFetcher) sends HTTP GET requests to external APIs
   - API returns JSON response containing OHLCV data

3. **Data Parsing Phase**:
   - BaseParser (YahooFinanceParser or FinanceBirdParser) receives JSON string
   - JsonReader streams through JSON, extracting fields defined in JsonConstants
   - Parser creates Candlestick objects and aggregates them into TradingPeriod
   - DecimalFormat ensures proper numeric formatting

4. **Data Persistence Phase**:
   - DatabaseInputValidator validates Candlestick data
   - CandlestickDao executes prepared statements to insert data
   - Database stores candlestick records with columns: symbol, timestamp, open, high, low, close, volume

5. **Error Handling**:
   - DataFetchException wraps HTTP and network errors
   - JsonParseException handles malformed JSON responses
   - SQLException manages database operation failures
   - All errors are logged via SLF4J Logger

## UML diagrams

- [Use-case diagram](doc/uml-diagrams/use-case.png)
- [Activity diagram](doc/uml-diagrams/activity.png)
- [Component diagram](doc/uml-diagrams/component.png)
- [Sequence diagram](doc/uml-diagrams/sequence.png)
- [Package diagram](doc/uml-diagrams/package.png)
